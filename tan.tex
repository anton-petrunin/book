%%!TEX root = all.tex
\chapter{First order differentiation}\label{chap:tan}

\section{Tangent cone}

Recall that according to 
the corollaries \ref{cor:monoton:sup} 
and \ref{cor:monoton-cba:angle=inf},
the $\CBB{}{}$ spaces as well as $\cCat{}{}$ spaces have defined angles.
In particular, in both cases the space of directions as well as space of geodesic directions are defined at each point.
(See Section~\ref{sec:angles} for the related definitions.)

The Euclidean cone $\T_p=\Cone\Sigma_p$
over the space of directions $\Sigma_p$ at the point $p$ 
will be called \emph{tangent space} at $p$.
 

\section{Tangent cone}\label{sec:tan}

\parbf{Tangent cones and vectors.}
Here we give a definition of tangent cone which works for general metric space.
It should be noted however that the definition below defines a reasonable object only for reasonable spaces, which include $\CBB{}{}$ and $\cCat{}{}$ spaces.

\begin{thm}{Definition}\label{def:tan}
Let $\spc{X}$ be a metric space and $p\in\spc{X}$.
Consider the set $\Gamma_p$ of all constant-speed geodesics which start at $p$;
i.e. $\gamma\in\Gamma_p$ iff $\gamma(t)=\geod_{[pq]}(\lam\cdot t)$ for some $\lam\ge0$.
($\Gamma_p$ includes the constant geoesic $\gamma(t)\equiv p$.)
Let us define a pseudometric on $\Gamma_p$ as
\[\dist{\gamma}{\gamma'}{\Gamma_p}
=
\limsup_{t\to0+}\frac{\dist{\gamma(t)}{\gamma'(t)}{\spc{X}}}{t}\]
for $\gamma,\gamma'\in\Gamma_p$.

The corresponding metric space  for $\Gamma_p$ will be called the \emph{geodesic tangent cone} of $\spc{X}$ at $p$; 
it will be denoted as $\T_p'=\T_p'\spc{X}$.
The completion of $\T_p'$ will be called the tangent cone at $p$, and denoted by $\T_p=\T_p\spc{X}$.
The elements of the  tangent cone will be called \emph{tangent vectors}
(despite in general $\T_p$ is not a vector space).
\end{thm}

Given $\lam\ge0$, there is a natural map $\Gamma_p\to\Gamma_p\:\gamma(t)\mapsto\gamma(\lam\cdot t)$.
For the induced map $\T_p\to\T_p$, we use the notation $v\mapsto \lam\cdot v$.
Clearly, 
\[\dist[{{}}]{\lam\cdot v}{\lam\cdot w}{}=\lam\cdot\dist[{{}}]{v}{w}{}.\]

Given a geodesic $[p q]$, 
the element in $\T_p$ that corresponds to $\geod_{[p q]}$ 
will be called the \emph{direction}\index{direction} of $[p q]$, denoted by $\dir{p}{q}$\index{$\dir{*}{*}$}.
The element in $\T_p$ that corresponds to the geodesic path $\gamma(t)=\geod_{[p q]}(\tfrac{t}{\dist{p}{q}{}})$ 
will be called \emph{logarithm}\index{logarithm} of $[p q]$ and denoted as $\ddir{p}{q}$\index{$\dir{*}{*}$};
clearly 
\[\ddir{p}{q}=\dist[{{}}]{p}{q}{}\cdot\dir{p}{q}.\]

The set of directions of all geodesics from $p$ to $q$ will be denoted by $\Dir{p}{q}$\index{$\Dir{{*}}{{*}}$}.
In general, the set $\Dir{p}{q}\subset\T_p$ might be empty.

%???Showld we call a metric space with a chousen one-parameter family of such maps a cone?


\parbf{Right/left derivatives.}
The definitions of right and left derivatives of curves is given in a few steps;
we first define it for geodesics and then extend it to general curves.

\begin{thm}{Definition}\label{def:curv^+}
Given $\gamma\in\Gamma_p$, we say that $v\in \T_p$ is the right derivative of $\gamma$ at $0$ (briefly, $v=\gamma^+(0)$)
if $\gamma$ maps to $v$ under 
the natural map $\Gamma_p\to \T_p'\subset\T_p$.

Further, let $\II$ be a real interval containing $[0,\eps)$ for some $\eps>0$.
Let  $\alpha\:\II\to\spc{X}$ be a map, 
$\alpha(0)=p$ and $v\in\T_p$.
We write
$v=\alpha^+(0)$
if there is a sequence $\gamma_n\in\Gamma_p$
such that $\gamma^+_n(0)\to v$ as $n\to\infty$ and 
\[\lim_{n\to\infty}(\limsup_{t\to0+}{\dist{\alpha(t)}{\gamma_n(t)}{}}/{t})\to 0.\]

Naturally, we define right/left derivatives of $\alpha$ at $t_0\in\II$ as $\alpha^\pm(t_0)=\check\alpha^+(0)$, where $\check\alpha(t)=\alpha(t_0\pm t)$.
\end{thm}

\parbf{Remarks.} 
Although the above definition will be mostly used for curves, 
we do not require $\alpha$ to be continous.

Note that our sign convention is not standard. 
In particular, for  a smooth curve $\alpha$ in the Euclidean space we have $\alpha'=\alpha^+ =- \alpha^-$.

\begin{thm}{Proposition}\label{prop:unique-right-der}
Let $\spc{X}$ be a metric space,
$p\in \spc{X}$,
$\eps>0$.

\begin{subthm}{prop:unique-right-der:unique}
Given a map $\alpha\:[0,\eps)\to\spc{X}$ such that $\alpha(0)=p$,
there is at most one tangent vector $v\in\T_p$ 
such that $v=\alpha^+(0)$.
\end{subthm}

\begin{subthm}{prop:unique-right-der:exist}
 For any tangent vector $v\in \T_p$ there is a map $\alpha\:[0,\eps)\to\spc{X}$ such that $\alpha^+(0)=v$.
\end{subthm}

\begin{subthm}{prop:unique-right-der:chain}
Given a map $\alpha\:[0,\eps)\to\spc{X}$ such that $\alpha(0)=p$,
and $\theta(t)=\lam\cdot t+o(t)$, $\lam>0$,
we have 
\[(\alpha\circ\theta)^+(0)=\lam\cdot\alpha^+(0).\]
In particular, left part is defined if and only if the right part is defined.
\end{subthm}
\end{thm}

\parit{Proof.} Parts \ref{SHORT.prop:unique-right-der:unique} and \ref{SHORT.prop:unique-right-der:chain} follow directly from definitons \ref{def:curv^+} and \ref{def:tan}.

Let $\gamma^+_n(0)\to v$ be as in the definition \ref{def:curv^+} and $t_n\to0+$ be a monotonic sequence.
Define $\alpha(t)=\gamma_n(t)$ for $t\in (t_{n+1},t_n]$.
For appropriately chousen sequence $(t_n)$, the map $\alpha$ satisfies (\ref{prop:unique-right-der:exist}).
\qeds



\begin{thm}{Definition}\label{def:diff-curv}
Let 
$\spc{X}$ be a metric space 
and $\alpha\:\II\to \spc{X}$ be a curve.

For $t_0\in\II$, 
if $\alpha^+(t_0)$ or $\alpha^-(t_0)$ or both are defined,
we say correspondingly that  $\alpha$ is \emph{right}\index{differentiable!right differentiable} or \emph{left}\index{differentiable!left differentiable} or \emph{both-sided differentiable}\index{differentiable!both-sided differentiable} at $t_0$.
In the exceptional cases where $t_0$ is the left (respectively right) end of $\II$, $\alpha$ is by definition left (respectively right) differentiable at $t_0$.
\end{thm}

\section{Differential}

\begin{thm}{Definition}
Let $f\:\spc{X}\subto\RR$ be a subfunction and $p\in\Dom f$ and $\II$ be a real interval.
A function $\phi\:\T_p\to\RR$ is called differential of $f$ at $p$
(briefly $\phi=\d_pf$) if for any map $\alpha\:\II\to \spc{X}$ such that $\alpha(0)=p$ and $\alpha^+(0)$ is defined, we have \[(f\circ\alpha)^+(0)=\phi(\alpha^+(0)).\]
\end{thm}

\begin{thm}{Proposition}\label{prop:differential}
Let $f\:\spc{X}\subto\RR$ be a locally Lipschitz semiconcave subfunction.
Then differential $\d_pf$ is uniquely defined for any $p\in\Dom f$. Moreover, 
\begin{subthm}{prop:differential:lip}
$\d_pf\:\T_p\to\RR$ is Lipschitz and its Lipschitz constant does not exceed the Lipschitz constant of $f$ in a neighborhood of $p$. 
\end{subthm}

\begin{subthm}{prop:differential:homo}
$\d_pf\:\T_p\to\RR$ is a positive homogenius function;
i.e. for any $\lam\ge 0$ and $v\in\T_p$ we have 
\[\lam\cdot\d_pf(v)=\d_pf(\lam\cdot v).\]
\end{subthm}



\end{thm}


\parit{Proof.}
The uniqueness of differential follows from the second part of \ref{prop:unique-right-der}.

Passing to a subdomain of $f$ if nesessary,
we can assume that $f$ is $\Lip$-Lipschitz and $\lambda$-concave for some $\Lip,\lambda\in\RR$.

Take a geodessic $\gamma\in \Gamma_p$ which lies in $\Dom f$.
Since $f\circ\gamma$ is semiconcave,
the rigth derivative $(f\circ\gamma)^+(0)$ is defined.
Since $f$ is  $\Lip$-Lipschitz, we have
\[|(f\circ\gamma)^+(0)-(f\circ\bar\gamma)^+(0)|
\le
\Lip\cdot\dist[{{}}]{\gamma^+(0)}{\bar\gamma^+(0)}{}\eqlbl{gam-bargam}\]
for any $\gamma,\bar\gamma\in\Gamma_p$.
Define $\phi\:\T'_p\to\RR\:\gamma^+(0)\mapsto(f\circ\gamma)^+(0)$.
From \ref{gam-bargam}, $\phi$ is a $\Lip$-Lipschtz function defined on $\T_p'$.
Thus, we can extend $\phi$ to a whole $\T_p$ as a $\Lip$-Lipschitz function. 

It remains to show that $\phi$ is differential of $f$ at $p$.
Let  $\alpha$ be a curve in $\spc{X}$ and $\alpha^+(0)=v\in \T_p$.
Let $\gamma_n\in\Gamma_p$ be a sequence of geodesics as in the definiton \ref{def:curv^+};
i.e. if 
\[v_n=\gamma^+_n(0)\ \ \t{and}\ \ a_n= \limsup_{t\to0+}{\dist{\alpha(t)}{\gamma_n(t)}{}}/{t}\] 
then $a_n\to 0$ and $v_n\to v$ as $n\to\infty$.
Then $\phi(v)=\lim_{n\to\infty}\phi(v_n)$, $f\circ\gamma_n(t)=f(p)+\phi(v_n)\cdot t+o(t)$ and by proposition \ref{prop:unique-right-der}, we have 
\[|f\circ\alpha(t)-f\circ\gamma_n(t)|\le\Lip\cdot\dist[{{}}]{\alpha(t)}{\gamma_n(t)}{}.\]
Hence 
\[f\circ\alpha(t)=f(p)+\phi(v)\cdot t+o(t)\]
\qedsf


\section{Tangent space in CBB spaces}\label{sec:tan-cbb}


\parbf{Space of directions.}
Let $\spc{L}\in \CBB{}{}$ and $p\in \spc{L}$.
Consider set of all unit-speed geodesics $\Gamma_p$ starting at $p$.
According to \ref{claim:angle-3angle-inq}, the angle measure $\mangle$ gives a pre-metric on $\Gamma_p$.
The factor-space $\Sigma_p'=\Gamma_p'/\sim$ by the equivalence relation 
\[\gamma_1\sim\gamma_2\ \ \text{iff}\ \ \mangle(\gamma_1,\gamma_2)=0\] 
will be called \emph{space of geodesic directions}\index{space of directions!space of geodesic directions} of $\spc{L}$ at $p$.
The completion of $\Sigma'_p$\index{$\Sigma'_{*}$}, will be called \emph{space of directions}\index{space of directions} of $\spc{L}$ at $p$ and denoted by $\Sigma_p=\Sigma_p \spc{L}$\index{$\Sigma_{*}$}.
The angle $\mangle$ defines metric on $\Sigma_p'$ and it extends to a metric on $\Sigma_p$; further we allways denote by $\Sigma_p$, the metric space $(\Sigma_p,\mangle)$.

Given a geodesic $[p q]$, the corresponding direction in $\Sigma_p$ will be denoted by $\dir{p}{q}$\index{$\dir{*}{*}$}.
The set of all directions of geodesics from $p$ to $q$ will be denoted by $\Dir{p}{q}$\index{$\Dir{{*}}{{*}}$}.
In general, the set $\Dir{p}{q}\subset\Sigma_p$ might be empty.

\parbf{Tangent cone.} $\Cone\Sigma_p$ --- the Euclidean cone over $\Sigma_p$ (see \ref{cones}) will be called \emph{tangent space}\index{tangent space} of $\spc{L}$ at $p$ and we denote it by $\T_p=\T_p \spc{L}$\index{$\T_{*}$}.
As well as space of directions, tangent cone is a complete space.
Set \index{$\ddir{*}{*}$}\index{$\ddir{*}{*}$}
\[\ddir p q\,
\df
\dist[{{}}]{p}{q}{}\cdot\dir p q
\ \ \hbox{and} \ \ 
\Ddir{p}{q}
=
\set{\dist[{{}}]{p}{q}{}\cdot\xi}{\xi\in\Dir{p}{q}}
.\]
Note that $\ddir p q=\ddir p{q'}$ implies $q=q'$; see ???.
The relation $v=\ddir p q$, will be also written as $q=\exp_p v$.
The map $\exp_p$ is defined on a starshaped subset of $\T_p$; 
i.e. if $\exp_pv$ is defined then so is $\exp_p(t\cdot v)$ for any $t\in[0,1]$. 

The subcone $\T_p'=\Cone\Sigma_p'\subset \T_p$ will be called subcone of \emph{geodesic vectors}\index{geodesic tangent vector}.
Clearly, $\T_p'$ is dense in $\T_p$ and $v\in \T_p'$ iff $\exp_p(\eps\cdot v)$ is defined for small $\eps$.

\section{Differentiability of curves.}

Let 
$\spc{L}\in\CBB{}{}$,
$\alpha\:\II\to \spc{L}$ be a curve
$t_0\in \II$
and $p=\alpha(t_0)$.
We say that $v\in\T_p$ is a \emph{right} (\emph{left}) \emph{derivative} of $\alpha$ at $t_0\in\II$, 
briefly, $v=\alpha^+(t_0)$ (correspondingly $v=\alpha^-(t_0)$)
if there is a sequence $v_n\in\T_p'$ such that $v_n\to v$
and $s_n\to 0$ as $n\to\infty$, where
\[s_n=\limsup\frac{\dist{\alpha(t)}{\exp_p(|t-t_0|\cdot v_n)}{}}{|t-t_0|}\]
and the limit is taken for $t\to t_0+$ (correspondingly $t\to t_0-$).

\begin{thm}{Lemma}
Let
$\spc{L}\in\CBB{}{}$,
$\alpha\:\II\to \spc{L}$ be a curve
$t_0\in \II$
and $p=\alpha(t_0)$.
if for any $w\in\T_p'$ we have
\[\lim\frac{\dist{\alpha(t)}{\exp_p(|t-t_0|\cdot w)}{}}{|t-t_0|}
=
\dist{v}{w}{\T_p}.\]
where the limit is taken for $t\to t_0+$ (correspondingly $t\to t_0-$).
\end{thm}


For an interior value $t_0$ of $\II$, 
if $\alpha^+(t_0)$ or $\alpha^-(t_0)$ or both are defined,
we say correspondingly that  $\alpha$ is \emph{right}\index{differentiable!right differentiable} or \emph{left}\index{differentiable!left differentiable} or \emph{both-sided differentiable}\index{differentiable!both-sided differentiable} at $t_0$.
In the exceptional cases, when $t_0$ is the left (correspondingly right) end of $\II$, $\alpha$ is by definition left (correspondingly right) differentiable at $t_0$.

For an interior value $t_0$ of $\II$,
in case if $\alpha$ is both-sided differentiable at $t_0$ and $\alpha^+(t_0)+\alpha^-(t_0)=0$, we say that $\alpha$ is \emph{differentiable}\index{differentiable} at $t_0$.
In the exceptional cases, when $t_0$ is the left (correspondingly right)
we say that $\alpha$ is both-sided differentiable at $t_0$ if $\alpha$ is right (correspondingly left) differentiable at $t_0$.

\begin{thm}{Lemma}
Let $\spc{L}\in\CBB{}{}$ and $\gamma\:\II\to\spc{L}$ be a geodesic then $\gamma$ is both-side differentiable.
\end{thm}

\begin{thm}{Lemma}
Let $\spc{L}\in\CBB{}{}$ and $\alpha\:\II\to\spc{L}$ be a Lipschitz curve then $\alpha$ is almost everywhere both-side differentiable.
\end{thm}










\section{Tangent and ultratangent space} 

For a space $\spc{L}\in\CBB{}{}$,
we already defined two types of tangent cones at a given point $p$:
\begin{enumerate}
\item the tangent space, $\T_p=\T_p\spc{L}$, defined in section \ref{sec:tan}
\item maybe add $\T_p\spc{L}^\o$???
\item ultratangent space for an ultrafilter $\o$,
$\T_p^\o=\T_p^\o\spc{L}$
which is defined in Section~\ref{ultralimits}.
\end{enumerate}
Both of these notions are analogous to tangent space of Riemannian manifold.
If the dimension is finite, then these two notions coincide, see \ref{thm:tan4finite}.
In infinite-dimensional case, they are different and both useful; 
often lack of a property in one is compensated by the other.

\medskip

It is clear from the definition that tangent space has cone structure.
On the other hand, in general, ultratangent space does not have a cone structure; a Hilbert's cube $\prod_{n=1}^\infty[0,2^{-n}]\in\CBB{}0$ gives an example.

In general, the metric on $\T_p$ might be not a length-metric;
see Halbeisen's example (Section~\ref{halbeisen}).
In this case, by definition $\T_p\notin\CBB{}{0}$; for $\T^\o_p$ the situation is better:

\begin{thm}{Theorem}\label{thm:tan-is-CBB}
If $\spc{L}\in\CBB{}\kappa$ and $p\in \spc{L}$ then $\T^\o_p\in\CBB{}{0}$.
\end{thm}

\parit{Proof.}
Since $\spc{L}\in\CBB{}\kappa$, then for its blowup $n\blow\spc{L}$, we have $n\blow\spc{L}\in\CBB{}{\kappa/{n^{2}}}$.
Sinse $n\blow(\spc{L},p)\to(\T_p^\o,\0)$ as $n\to\o$, Proposition~\ref{prp:A^omega} implies ${\T^\o_p}\in\CBB{}{0}$.
\qeds

The next theorem shows that $\T_p$ can be (and often will be) considered as a subset of  $\T^\o_p$.
That also implies that (1+3)-point comparison (\ref{df:cbb1+3}) as well as $n$-point comparison (\ref{thm:pos-config}) holds in $\T_p$.

\begin{thm}{Theorem}
\label{thm:T-in-T^w} 
Let $L\in\CBB{}\kappa$.
For any $p\in \spc{L}$, there is an distance preserving map $\iota:\T_p\hookrightarrow \T^\o_p$ such that 
 if $n\cdot\ddir p {q_n}\to v$ as $n\to\infty$ 
then $n\blow q_n\to\iota(v)$ as $n\to\o$.
\end{thm}

\parit{Proof.}
Let us first define $\iota\:\T_p'\to\T^\o_p$, where $\T_p'=\Cone\Sigma_p'\subset \T_p$ the subcone of geodesic vectors (see Section~\ref{sec:tan}).
Given $v\in \T_p'$ the exponent $v_n=\exp_p(\tfrac{1}{n}\cdot v)$ is defined for all large $n$.
Set $\iota(v)=v_\o$.

Since angles between geodesics in $\spc{L}$ are defined (see \ref{angle}), for any $v,w\in \T_p'$ we have
$n\cdot\dist[{{}}]{v_n}{w_n}{}\to\dist{v}{w}{}$.
Thus $\dist{v_\o}{w_\o}{}=\dist{v}{w}{}$, i.e. $\iota$ is a global isometry of $\T_p'$.
Since $\T_p'$ is dense in $\T_p$,
we can extend $\iota$ to a global isometry $\T_p\to \T^\o_p$.
\qeds


\begin{thm}{Theorem}\label{thm:sect}
Let $\spc{L}\in\CBB{}\kappa$ and $p\in \spc{L}$.
Given two tangent vectors $u,v\in \T_p$, consider model triangle $\trig{\~\0}{\~u}{\~v}=\modtrig0(\0 u v)$ 
and denote by $\Sect(u v)$ the region in $\EE^2$ bounded by rays $\~\0\~u$ and $\~\0\~v$.

Then for any geodesic $[u v]$ in $\T^\o_p$ there is a distance preserving map $\iota\:\Sect(u v)\to\T^\o_p$ such that $\iota(\~\0)=\0$, $\iota([\~u\~v])=[u v]$.
\end{thm}

\parit{Proof.}
Follows directly from the lemma on flat triangle (\ref{lem:flat-trig}).
\qeds







\section{Linear subspace of tangent space}

\begin{thm}{Definition}\label{def:opp+Lin}
Let $\spc{L}\in\CBB m\kappa$, $p\in \spc{L}$ and $u,v\in\T_p$.
We say that vectors $u$ and $v$ are \emph{opposite}\index{opposite}\label{def:opposite:page} to each other, (briefly, $u+v=0$) if $|u|=|v|$ and $\mangle(u,v)=\pi$ or $|u|=|v|=0$.

The subcone
\[\Lin_p=\{v\in\T_p\mid\exists\ w\in\T_p\ \ \t{such that}\ \ w+v=0\}\]
will be called \emph{linear subcone}\index{linear subspace} of $\T_p$.
\end{thm}

The reason for choosing the name ``linear subcone'' will be evident after proving Theorem~\ref{thm:lin-subcone}.

Let $u\in \Lin_p$, $u+v=0$ and $s<0$.
Set $s\cdot u=(-s)\cdot v$.
This way we define multiplication of any vector in $\Lin_p$ by any real number (positive and negative).
Proposition~\ref{prop:two-opp} implies that such multiplication is uniquely defined.

\begin{thm}{Proposition}\label{prop:opposite}
Let $\spc{L}\in\CBB{}{}$ and $p\in \spc{L}$.
Given two vectors $u,v\in\T_p$, the following statements are equivalent:
\begin{subthm}{opposite} $u+v=0$;
\end{subthm}
\begin{subthm}{<x,u>} $\<u,x\>+\<v,x\>=0$ for any $x\in\T_p$;
\end{subthm}
\begin{subthm}{<xi,u>} $\<u,\xi\>+\<v,\xi\>=0$ for any $\xi\in\Sigma_p$.
\end{subthm}
\end{thm}

\parit{Proof.}
The condition $u+v=0$ is equivalent to $\<u,u\>=-\<u,v\>=\<v,v\>$;
thus 
(\ref{SHORT.<x,u>})$\Rightarrow$(\ref{SHORT.opposite}).
Since $\T_p$ is isometric to a subset of $\T^\o_p$,
the splitting theorem (\ref{thm:splitting}) applied for $\T_p^\o$
gives (\ref{SHORT.opposite})$\Rightarrow$(\ref{SHORT.<x,u>}).
The equivalence  (\ref{SHORT.<x,u>})$\Leftrightarrow$(\ref{SHORT.<xi,u>}) is trivial.
\qeds

\begin{thm}{Proposition}\label{prop:two-opp}
Let $\spc{L}\in\CBB{}{}$ and $p\in \spc{L}$.
Then for any three vectors $u,v,w\in\T_p$, $u+v=0$ and $u+ w=0$ implies $v=w$.
\end{thm}

\parit{Proof.} From Proposition~\ref{prop:opposite} both $v$ and $w$ satisfy the condition in corollary~\ref{cor:polar}. 
Hence the result.\qeds


\begin{thm}{Theorem}\label{thm:lin-subcone}
Let $\spc{L}\in\CBB{}{\kappa}$ and $p\in \spc{L}$. 
Then $\Lin_p$ forms a subcone of $\T_p$ isometric to a Hilbert space.
\end{thm}

\begin{thm}{Corollary}\label{cor:euclid-subcone}
Let $\spc{L}\in\CBB{}{\kappa}$ 
and $p\in \Str(x_1,x_2,\dots,x_n)$.
Then there is a subcone $E\subset \T_p$ which isometric to a Euclidean space such that $\ddir p{x_i}\in E$ for every $i$.
\end{thm}

\parit{Proof.} 
By the definition of $\Str$ (\ref{def:straight}), $\ddir{p}{x_i}\in \Lin_p$ for each $i$.
It remains to apply Theorem~\ref{thm:lin-subcone}.
\qeds

The main difficulty in the proof of Theorem~\ref{thm:lin-subcone} comes from the fact that in general $\T_p\notin\CBB{}{0}$;
see Habeisen's example (Section~\ref{halbeisen}).
Otherwise the statement would follow directly from the Splitting theorem (\ref{thm:splitting}).
In fact the proof of this theorem is a far walk around, in the proof we use construction of gradient, as well as Splitting theorem, proof of which use gradient flow.
Thus in order to understand our proof completely one needs to read most of Chapter~\ref{chap:grad}.

First we give a construction of a tangent vector $w$ for given two vectors $u,v$.
If the tangent space is Euclidean, then  $w=-u-v$.




\parit{Proof of \ref{thm:lin-subcone}.}
First we show that $\Lin_p\in \CBB{}{0}$.

Note that $\T^\o_p\in \CBB{}{0}$ (see \ref{thm:tan-is-CBB}) and $\Lin_p$ is a closed subset of $\T^\o_p$.
Thus, it is sufficient to show that the metric on $\Lin_p$ inherited from $\T^\o_p$ is a length-metric.

Given two vectors $x,y\in\Lin_p$,
let us apply Lemma~\ref{lem:minus-sum} 
for vectors $u$ and $v$ such that $u+\tfrac{1}{2}\cdot x=0$ 
and $v+\tfrac{1}{2}\cdot y=0$ in order to show that  $w\in \T_p$ is a midpoint of $[x y]$.
First note that 
\begin{align*}
|w|^2
&=
-\<w,u\>-\<w,v\>
=
\\
&=
\tfrac{1}{2}\cdot\<w,x\>+\tfrac{1}{2}\cdot\<w,y\>.
\\
\intertext{Therefore,}
\dist[2]{x}{w}{}+\dist[2]{w}{y}{}
&=2\cdot|w|^2+|x|^2+|y|^2-2\cdot\<w,x\>-2\cdot\<w,y\>=\\
&=|x|^2+|y|^2-\<w,x\>-\<w,y\>\le\\
&\le |x|^2+|y|^2+\<u,x\>+\<v,x\>+\<u,y\>+\<v,y\>=\\
&=\tfrac{1}{2}\cdot|x|^2+\tfrac{1}{2}\cdot|y|^2-\<x,y\>=\\
&=\tfrac{1}{2}\cdot\dist[2]{x}{y}{}.
\end{align*}
Thus $\dist{x}{w}{}=\dist{w}{y}{}=\tfrac{1}{2}\cdot\dist[{{}}]{x}{y}{}$; 
i.e. $w$ is a midpoint for $x$ and $y$.

Note that for any $v\in\Lin_p$ there is a line $\ell$ passing trough $v$ and $\0$, thus applying \ref{cor:splitting}, we get that $\Lin_p$ is isometric to a Hilbert space.
\qeds








\section{Differential and ultradifferential}\index{differential}

\begin{thm}{Definition}\label{def:differential}
Let $\spc{L}\in\CBB{}{}$, 
$f\:\spc{L}\subto \RR$ be a locally Lipschitz subfunction
and $p\in\Dom f$.
A function $\phi\:\T_p\spc{L}\to\RR$ is called differential of $f$ at $p$ (briefly, $\phi=\d_p f$)
if for any curve $\alpha\:[0,\eps)\to\spc{L}$ such that $\alpha(0)=p$ and $\alpha^+(0)$ is defined w have
\[(\d_pf)(\alpha^+(0))=(f\circ\alpha)^+(0).\]
 
\end{thm}



\begin{thm}{Proposition}
Let $\spc{L}$ be a metric space with defined angles between geodesics, 
$f\:\spc{L}\subto \RR$ be a locally Lipschitz semiconcave subfunction.
Then for any $p\in\Dom f$, its differential $\d_p f$ is defined.
\end{thm}


Let $\spc{L}$ be a metric space, 
$f\subto \RR$
and $p\in\Dom f$.
A function $\phi\:\T_p\spc{L}\to\RR???$ is called differential of $f$ at $p$ (briefly, $\phi=\d_p f$)
if for any curve $\gamma(t)$ in $\spc{L}$ such that $\gamma(0)=p$ and $\gamma^+(0)$ is defined we have
\[\phi(\gamma^+(0))=(f\circ\gamma)^+(0).\]

???

Let $\spc{L}\in\CBB{}\kappa$ and $f\:\spc{L}\subto\RR$ be semiconcave. 
Let us construct differential $\d_p f\:\T_p\to \RR$ of $f$ at $p\in\Dom f$.

Given a unit-speed geodesic $\gamma$ starting at $p$ (i.e. $\gamma(0)=p$), let us set
\[(\d_p f)\l(\gamma^+(0)\r)
=(f\circ{\gamma})^+(0).\]
Since $f$ is semiconcave, $(f\circ{\gamma})^+$ is defined. 

That defines differential $\d_p f$ on $\Sigma'_p$.
It is easy to see that $\d_p|\Sigma'_p$ is upper semicontinuous;
thus, one can extend $\d_p$ to an upper semicontinuous function on $\Sigma_p$.

Further, extend $\d_p$ to a homogenous function of degree $1$ on $\T_p$; i.e. define 
\[(\d_p f)(\0)=0
\ \ \hbox{and}\ \ 
(\d_p f)(r\cdot\xi)
\df
r\cdot (\d_p f)(\xi)\] 
for any $\xi\in\Sigma_p$ and $r\ge 0$.

Note that $\dist{p}{}{}\:\spc{L}\to\RR$ is semiconcave in $\spc{L}\backslash\{p\}$.
Thus for any $q\not=p$ one can define differential.
The following claim follows directly from first variation formula (\ref{1st-var+}).

\begin{thm}{Theorem???}\label{thm:differential-of-dist}
Let $\spc{L}\in\CBB{}\kappa$ 
and $p,q\in \spc{L}$ be distinct points. 
Let $\Dir{p}{q}$ denotes the set of all directions of geodesics from $p$ to $q$ in $\spc{L}^\o$.
Then 
\[(\d_q\dist{p}{}{})(v)=-\sup\set{\<\xi,v\>}{\xi\in???\Dir{q}{p}}.\]
In particular, for any geodesic $[qx]$ we have
\[(\d_q\dist{p}{}{})(\dir qx)\ge -\cos\angk\kappa qxp\]
if the right hand side is defined.
\end{thm}


\begin{thm}{Theorem}\label{thm:d_q dist_p(v)=-<dri p q, v>}
Let $\spc{L}\in\CBB{}\kappa$ 
and $p,q\in \spc{L}$ be to distinct points such that there is unique geodesic $[p q]$ in $\spc{L}^\o$.
Then for any $v\in\T_q$, we have
\[(\d_q\dist{p}{}{})(v)=-\<\dir q p,v\>.\]
In particular, the above identity holds if $q\in \Str(p)$ and if $p\in \Str(q)$.
\end{thm}


In general, as it shown in Halbeisen's example (see section \ref{halbeisen}),  
$\T_p$  might be not an length space; 
thus concavity of $\d_p f$ is meaningless. 
Nevertheless, as the following lemma shows, differential $\d_p f$ of a semiconcave function allways satisfy the following weaker property similar to concavity (compare \cite[136]{plaut:survey}, \cite[4.2]{ohta}).  
Note that in finite dimensional case $\d_p f$ is concave (see ???), 
but again, we use gradient to prove some basic properties of dimension.

\begin{thm}{Lemma}\label{lem:ohta} 
Let $\spc{L}\in\CBB{}{\kappa}$,
$f\:\spc{L}\subto\RR$ be a locally Lipschitz semiconcave subfunction 
and $p\in \Dom f$.
Then
\[\sup\set{(\d_p f)(\xi)}{\xi\in\Sigma_p}
\ge 
\frac{(\d_p f)(u)+(\d_p f)(v)}{\sqrt{|u|^2+2\cdot\<u,v\> +|v|^2}}\]
for any $u,v\in \T_p$.
\end{thm}

\parit{Proof of \ref{lem:ohta}.}
We can assume that $\alpha=\mangle(u,v)>0$, otherwise the statement is trivial.
Moreover, since $\T'_p=\Cone(\Sigma'_p)$\index{$\T'_{{*}}$} is dense in $\T_p$ and $\d_p f\:\T_p\to\RR$ is Lipschitz, we can assume that $u,v\in \T'_p$, i.e. $\exp_p(t\cdot u)$
 and $\exp_p(t\cdot v)$ are defined for all small $t>0$.

\begin{wrapfigure}{r}{50mm}
\begin{lpic}[t(0mm),b(-5mm),r(0mm),l(5mm)]{pics/puvvw(0.4)}
\lbl[r]{1,1;$\~ p$}
\lbl[lb]{14,44;$\~ u$}
\lbl[lb]{53,5;$\~ v$}
\lbl[b]{105,5;$\~ v'$}
\lbl[lb]{34,23;$\~ w$}
\lbl[lb]{11,8;$\alpha$}
\end{lpic}
\end{wrapfigure}
Let us prepare a model configuration of five points: $\~p,\~u,\~v,\~v',\~w\in\EE^2$ such that
\begin{itemize}
\item $\mangle\hinge{\~p}{\~u}{\~v}=\alpha$, 
\item $\dist{\~p}{\~u}{}=|u|$, 
\item $\dist{\~p}{\~v}{}=|v|$, 
\item $\~v'$ lies on the extension of $[\~p\~v]$ so that $\~v$ is midpoint of $[\~p\~v']$, 
\item $\~w$ is the midpoint for $\~u$ and ${\~v}$.
\end{itemize}
Note that 
\[\dist{\~p}{\~w}{}=\tfrac{1}{2}\cdot\sqrt{|u|^2+2\cdot\<u,v\>+|v|^2}.\]

First, let us assume that $\spc{L}$ is geodesic.

For all small $t>0$, construct points $u_t,v_t,v'_t,w_t\in \spc{L}$ the following way:
\begin{itemize}
\item $v_t=\exp_p(t\cdot v)$,\ \  $v_t'=\exp_p(t\cdot v')$
\item\label{u_t}  $u_t=\exp_p(t\cdot u)$.
\item $w_t$ is the midpoint of $[u_t v_t]$.
\end{itemize}
Clearly $\dist{p}{u_t}{}=t|u|$, $\dist{p}{v_t}{}=t|v|$, $\dist{p}{v_t'}{}=t|v'|$. 
Since $\mangle(u,v)$ is defined, 
we have $\dist{u_t}{v_t}{}=t\dist{\~u}{\~v}{}+o(t)$ 
and $\dist{u_t}{v_t'}{}=t\dist{\~u}{\~v'}{}+o(t)$ 
(see Theorem~\ref{angle} and Section~\ref{sec:angle}).

From point-on-side and hinge comparison (\ref{point-on-side}$+$\ref{SHORT.angle}), we get that 
\[\angk\kappa{v_t}p{w_t}
\ge
\angk\kappa{v_t}p{u_t}
\ge
\mangle\hinge{\~v}{\~p}{\~u}+\tfrac{o(t)}t\]
and
\[\angk\kappa{v_t}{v_t'}{w_t}
\ge
\angk\kappa{v_t}{v_t'}{u_t}
\ge
\mangle\hinge{\~v}{\~v'}{\~u}+\tfrac{o(t)}t.\]
Clearly, 
$\mangle\hinge{\~v}{\~p}{\~u}+\mangle\hinge{\~v}{\~x}{\~u'}=\pi$. 
From adjacent angle comparison (\ref{2-sum}), 
$\angk\kappa{v_t}p{v_t}\z+\angk\kappa{v_t}{u_t}{v_t'}\le \pi$.
Hence
$\angk\kappa{v_t}p{w_t}
\to
\mangle\hinge{\~v}{\~p}{\~v}$ as $t\to0+$
and thus 
\[\dist{p}{w_t}{}=t\dist{\~p}{\~w}{}+o(t).\]

Since $f$ is $\lambda$-concave we have 
\begin{align*}
2\cdot f(w_t)&\ge f(u_t)+f(v_t)+\tfrac\lambda4\cdot\dist[2]{u_t}{v_t}{}=
\\
&=2\cdot f(p)
+t\cdot [(\d_p f)(u)+(\d_p f)(v)]+o(t).
\end{align*}
 
Applying $\lambda$-concavity of $f$, we get
\[(\d_p f)(\dir p{w_t})
\ge 
\frac{t\cdot[(\d_p f)(u)+(\d_p f)(v)]
+o(t)}{2\cdot t\cdot\dist[{{}}]{\~p}{\~w}{}+o(t)}
\eqlbl{eq:lem:ohta*}\]
and the lemma follows.

\medskip

Finally, in case $\spc{L}$ is not geodesic one needs to make two adjustments in the above constructions.
Namely: 
\begin{enumerate}[(i)]
\item For geodesic $[u_t v_t]$ to be defined, one has to take in (\ref{u_t}) $u_t\in \Str(v_t)$, $u_t\approx\exp_p(t\cdot u)$. 
More precicely, $\dist{u_t}{\exp_p(t\cdot u)}{}=o(t)$. 
Thus instead of $\dist{p}{u_t}{}=t|u|$ we only have $\dist{p}{u_t}{}=t|u|+o(t)$, but it is enough for the rest of proof.
\item the direction $\dir p{w_t}$ might be undefined.
Thus, in the estimate \ref{eq:lem:ohta*}, instead of $\dir p{w_t}$, one should take $\dir p{w'_t}$ for some $w_t'\in \Str(p)$, $w_t'\approx w_t$ (i.e. $\dist{w_t}{w_t'}{}=o(t)$)\qeds
\end{enumerate}


\parbf{Ultradifferential.}
Given a function $f\:\spc{L}\to\RR$, consider sequence of functions $f_n\:n\blow\spc{L}\to\RR$, defined by 
\[f_n(n\blow x)=n\cdot(f(x)-f(p)),\]
here $x$ and $p$  are considered as elements of the underling set $\ushort{\spc{L}}$.
While $n\blow(\spc{L},p)\to(\T^\o,\0)$ as $n\to\o$, 
functions $f_n$ converge to $\o$-differential of $f$ at $p$.
It will be denoted by $\d_p^\o f$, so
\[\d_p^\o f\:\T_p^\o\to\RR,\ \ \d_p^\o f=\lim_{n\to\o} f_n.\] 

Clearly, the $\o$-differential of locally Lipschitz subfunction is defined at each point of definition.
From \ref{lem:convex-olim}, it is also clear that if $\T^\o_p$ is an Alexandrov space with upper or lower curvature bound, 
then differential $\d^\o_p f$ of semiconcave locally Lipschitz function $f$ is concave.


\section{Halbeisen's example (alpha)}\label{halbeisen}

Here we give a construction of the following

\begin{thm}{Halbeisen's example}
There is a space $\check{\spc{L}}\in\CBB\infty{}$
with a point $p\in\check{\spc{L}}$ such that the space of directions $\Sigma_p\check{\spc{L}}$ and therefore the tangent space $\T_p\check{\spc{L}}$ is not a length space. 
\end{thm}

Our construction is just a minor variation of one in \cite{halbeisen}.
If the dimension is finite, such examples do not exist, see \ref{thm:tan4finite}; 
for proper spaces the question is open, see \ref{open:Halb-proper}.

\parit{Construction.}
Let $\HH$ be a Hilbert space formed by infinite sequences of real numbers $\bm{x}=(x_0,x_1,\dots)$ with norm
$|\bm{x}|^2=\sum_i(x_i)^2$. 
Fix $\eps=0.001$ and consider two functions $f,\check f:\HH\to\RR$
\[f(\bm{x})=|\bm{x}|,\]
\[\check f(\bm{x})
=
\max\left\{|\bm{x}|,\max_{n\in\NN}\{(1+\eps)\cdot x_n-\tfrac{1}{n}\}\right\}.\] 
Both of these functions are convex and Lipschitz, therefore their graphs in $\HH\times \RR$ equipped with its length-metric form infinite dimensional Alexandrov spaces, say $\spc{L}$  and $\check{\spc{L}}$ (it is proved formally in \ref{lem:hil-con}).
Set $p$ to be the origin of $\HH\times \RR$.

Note that $\check{\spc{L}}\cap\spc{L}$ is starshaped in $\HH$ with center at $p$.
Further $\check{\spc{L}}\backslash\spc{L}$ consist of countable number of disjointed sets
\[\Omega_n=\set{(\bm{x},\check f(\bm{x}))\in\check{\spc{L}}}{(1+\eps)\cdot x_n-\tfrac{1}{n}>|\bm{x}|}\]
and $\dist{\Omega_n}{p}{}>\tfrac{1}{n}$.
It follows that for any geodesic $[p q]$ in $\check{\spc{L}}$,
a small subinterval $[p \bar q]\subset [p q]$ 
coinsides with a straight segment in $\HH\times\RR$, 
which is also a geodesic in $\spc{L}$.
Thus we can treat $\Sigma_p\spc{L}$ and $\Sigma_p\check{\spc{L}}$ as one set, with two angle metrics $\mangle$ and $\check\mangle$;
let us denote by $\mangle_{\HH\times \RR}$ the angle in $\HH\times\RR$.

The space $\spc{L}$  is isometric to the Euclidean cone
over $\Sigma_p\spc{L}$ with vertex at $p$; 
$\Sigma_p\spc{L}$ is isometric to a sphere in Hilbert space with radius $\frac{1}{\sqrt{2}}$.
In particular, $\mangle$ is length-metric of $\Sigma_p{\spc{L}}$ in $\mangle_{\HH\times\RR}$.



Thus, to show that $\check \mangle$ does not define a length-metric on $\Sigma_p{\spc{L}}$
it is sufficient to construct a pair of directions $(\xi_+,\xi_-)$ such that
\[\check \mangle(\xi_+,\xi_-)<\mangle(\xi_+,\xi_-).\] 
Set $\bm{e}_0=(1,0,0,\dots)$, $\bm{e}_1=(0,1,0,\dots),\dots\in \HH$. 
Consider the following two rays in $\HH\times \RR$
\[\gamma_+(t)
=
\tfrac{t}{\sqrt{2}}\cdot(\bm{e}_0,1)
\ \  \text{and}\ \ 
\gamma_-(t)
=
\tfrac{t}{\sqrt{2}}\cdot(-\bm{e}_0,1),
\ \ t\in[0,+\infty).\] 
They form unit-speed geodesics in both, $\spc{L}$ and $\check{\spc{L}}$.
Let $\xi_\pm$ be the directions of $\gamma_\pm$ at $p$.
Denote by $\sigma_n$ the half-planes in $\HH$ 
spanned by $\bm{e}_0$ and $\bm{e}_n$;
i.e. $\sigma_n\z=\set{x\cdot\bm{e}_0+y\cdot\bm{e}_n}{y\ge 0}$.
Consider sequence of $2$-dimensional sectors $Q_n=\check{\spc{L}}\cap (\sigma_n\times \RR)$. 
For each $n$, the sector $Q_n$ passes through $\Omega_n$ and it is bounded by two geodesic rays $\gamma_\pm$.
Note that $Q_n\GHto Q$, where  $Q$ is a solid Euclidean angle
in $\EE^2$ with angle measure $\beta<\mangle(\xi_+,\xi_-)=\tfrac\pi{\sqrt{2}}$.
Indeed, $Q_n$ is isometric to the subset of $\EE^3$ described by
\begin{align*}
 y\ge0 \ \ 
\text{and}\ \  
&
z=\max\l\{\sqrt{x^2+y^2},
(1+\eps)\cdot y-\tfrac{1}{n} \r\}
\intertext{with length-metric.
Thus, its limit $Q$ is isometric to the subset of $\EE^3$ described by}
y\ge0
\ \ \text{and}\ \  
&
z=\max\l\{\sqrt{x^2+y^2},(1+\eps)\cdot y\r\}
\end{align*}
with length-metric.
In particular, for any $t,\tau\ge0$, 
\begin{align*}
\dist{\gamma_+(t)}{\gamma_-(\tau)}{\check{\spc{L}}} 
&\le 
\lim_{n\to\infty}\dist{\gamma_+(t)}{\gamma_-(\tau)}{Q_n}
=
\\ 
&=\side0 \{\beta;t,\tau\}.
\end{align*}
I.e., $\check\mangle(\xi_+,\xi_-) \le \beta<\mangle(\xi_+,\xi_-)$.\qeds

\begin{thm}{Lemma}\label{lem:hil-con}
Let $\HH$ be a Hilbert space,
$f\:\HH\to \RR$ be a convex Lipschitz function 
and $S\subset \HH\times \RR$ be the graph of $f$ 
equipped with length-metric.
Then $S\subset\CBB{}0$.
\end{thm}

\parit{Proof.} Recall that a subset $X\subset \HH\times \RR$, 
we will denote by $\dist{*}{*}{X}$ the
length-metric on $X$.

Note that according to \ref{thm:buyalo} any convex hypersurface in a Euclidean space equipped with length-metric is non-negatively curved.
Thus it is enough to show that for any 4-point set $\{x_0,x_1,x_2,x_3\}\subset S$, 
there is a finite-dimensional subspace $E\subset \HH\times \RR$, 
such that $\{x_i\}\in E$ and $\dist{x_i}{x_j}{S\cap E}$ is arbitrary close to $\dist{x_i}{x_j}{S}$.

Clearly $\dist{x_i}{x_j}{S\cap E}\ge \dist{x_i}{x_j}{S}$; 
thus it is enough to show that for given $\eps>0$ one can choose $E$, so that 
\[\dist{x_i}{x_j}{S\cap E}
<
\dist{x_i}{x_j}{S}+\eps
\eqlbl{eq:claim:hil-con*}\]

For each pair $(x_i,x_j)$ choose a broken line $\beta_{i j}$ connecting $x_i,x_j$, which lies under $S$ (i.e. outside of $\Conv S$) in $\HH\times \RR$ 
and has length at most $\dist{x_i}{x_j}{S}+\eps$.
Take $E$ to be the affine hull of all the vertexes in all $\beta_{i j}$.
Thus,
\[\dist{x_i}{x_j}{S\cap E}\le \length \beta_{i j}\] 
and \ref{eq:claim:hil-con*} follows.\qeds
















